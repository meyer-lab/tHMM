## Results

### Lineage information provides unique information about the source and dynamics of heterogeneity

To illustrate the unique value of lineage measurements when analyzing heterogeneous drug responses, we plotted a series of lineages from our measurements of the breast cancer cell line AU565 treated with gemcitabine (Fig. @fig:lineage). If we consider these to be two different, hypothetical populations, there is a striking difference in the divisions that the cells undergo as well as their contribution to the population’s growth, but the starting and ending cell numbers are nearly identical. As a result, endpoint, population-level drug response measurements cannot distinguish these inner differences. Measurements that record the history of cells (e.g., CFSE staining, Luria-Delbruck experiment) can help to distinguish these two populations but make assumptions about the dynamics of heterogeneity [@DOI:10.1073/pnas.1715639115; @PMID:28607484]. Lineage measurements, by contrast, provide sufficiently rich measurements to accurately quantify the extent and dynamics of heterogeneity. By observing individual cells, a variety of phenotypic measurements such as inter-mitotic times, cell cycle phase durations, motility, cell death and division, morphology, and protein and transcription factor levels can be characterized in parallel.

![**Population-based measurements are insufficient to distinguish the dynamics of heterogeneity.**  Lineages of AU565 cells (a) treated with 5 nM gemcitabine with relatively homogeneous dynamic, (b) control condition where cells in green are slow-dividing and blue cells are fast dividing. Both lineages have the same initial and final number of cells during the experiment; however, their dynamics are different. Each line refers to one cell that lived and when the line branches into two lines, means the cell divided.](./output/figure1.svg){#fig:lineage}

### A tHMM infers the state of cells given measurements on lineage trees

Given the unique insights that single-cell measurements on lineage trees can provide, we wished to implement a strategy for classifying cells based on their phenotype and relationships. Given a set of measurements made across a lineage tree, we used a lineage tree-based hidden Markov model (tHMM) to fit these data (Fig. {@fig:tree}a). Just like a typical hidden Markov model, a tHMM can infer the hidden discrete states of cells given a series of measurements. This takes place using an iterative strategy wherein the states of each cell are predicted given distributions that describe the phenotype of cells in each state (“expectation” step), and then each distribution of phenotypes is fit to match the cells within that state (“maximization” step) (Fig. {@fig:tree}b). This expectation-maximization (EM) process repeats until convergence.

After fitting, the tHMM model provides a variety of information (Fig. {@fig:tree}c). First, this process provides an estimate for the starting abundance of each state and the probability of transitions between them. Second, the phenotypes of cells in each state are estimated and can be compared to distinguish how each state behaves. The state of each cell can be predicted from the fit data or new measurements. Finally, the model provides a likelihood of each cell’s observations and therefore the data overall. This last quantity can be used, for example, to estimate the number of cell states with distinguishable behavior. When implementing these processes, we ensured that a cell’s measurements are defined through a modular interface. This allows other forms of data to be easily integrated.

![**The tHMM interface.** (a) Input data takes the form of single-cell measurements, where the lineage relationship between cells is known. (b) The fitting process includes expectation and maximization steps, where model parameters are iteratively updated until convergence. (c) Output predictions of the model after fitting including the tree of inferred cell states, probabilities of transition between each state, starting abundance of each cell state, and distributions that describe the behavior of cells within each state. The model likelihood can be used to estimate the number of distinguishable cell states.](./output/figure2.svg){#fig:tree}

### Experiments of finite time necessitate data censorship corrections

Modeling the duration of each cell’s lifetime is complicated by the influence of experimental factors. Specifically, cells at the beginning or end of an experiment are cut off and so, while we observe them, we do not know the duration of their cell cycle phases. Previously, this has been addressed by simply removing incompletely-observed cells [@doi:10.7554/eLife.51002]. However, doing so results in a systematic bias, where longer-lived cells are preferentially eliminated. On the other hand, treating these truncated values like they were not truncated also creates a systematic bias; for example, it would create an upper bound on the possible cell lifetime.

To incorporate this effect into our model, we marked cells or their specific cell cycle phase that encountered the bounds of the experiment as censored. When estimating the properties of a cell’s lifetime or the probability of a cell’s observation, these cells instead used a censored estimator or the survival function of the distribution. Using synthetic data, we verified that this correction resulted in accurate phenotype estimations (Fig. @fig:censor). This ensures that we can accurately infer cell states despite this experiment effect.

![**Experiments of finite time necessitate data censorship corrections.** (a) Randomly generated uncensored two-state lineages. (b) State assignment accuracy with uncensored lineages. (c) Randomly generated censored two-state lineages. State 0 and 1 cells are shown in different colors. (d) State assignment accuracy with experiment time- and cell death-censored lineages. Each scatter point represents the state assignment accuracy of a lineage with the shown cell number that has been fitted to the model.](./output/figure4.svg){#fig:censor}

### Synthetic lineage benchmarks show a tHMM can accurately estimate population behavior

To evaluate how accurately a tHMM model could infer the behavior of multi-state cell populations, we used synthetic populations of cells in a wide variety of configurations. In each case, we determined that our implementation of a tHMM model could accurately and without bias infer the hidden states and parameters of a population given roughly 100 cells. This synthetic data included situations that were not censored (Figs. @fig:uncenSingle, @fig:uncenMulti, @fig:performUncenSingle, @fig:performUncenMulti) and censored due to cell death and experimental duration to be a valid representative of experimental lineages (@fig:performSyn, @fig:performCenMulti, @fig:cenMulti). In addition to varying the number of cells in a population, we benchmarked populations with varied percentages of cell states (Figs. @fig:prop4, @fig:real_5) and varied phenotypic differences between the states (Figs. @fig:wass1, @fig:wass2, @fig:wass). In total, this benchmarking showed that our tHMM model would provide accurate results.

More specifically, one of the benchmarking studies we performed was with data matching our measurements of AU565, where G1 and S/G2 phase periods were quantified (Fig. {@fig:performSyn}a). Although the tHMM model was fit with no information about the true underlying parameters of the simulated cells, it accurately distinguished the two underlying cell states phenotypes (Fig. {@fig:performSyn}b–d) and member cells (Fig. {@fig:performSyn}e). Note that in Fig. {@fig:performSyn}d the Wasserstein distance between the true and estimated distributions for each state is much lower than the distance for any two distributions that are considered the same (Fig. {@fig:wass}b). On the population level, the transition and starting probabilities were accurately estimated (Fig. {@fig:performSyn}f–g). Thus, we are confident that, with similar experimental data, we should derive accurate results.

![**Model performance on censored lineages of increasing breadth and depth.** (a) Two state populations of increasing breadth (increasing number of lineages or initial cells) and of increasing depth (increasing experiment time) are analyzed. The states are shown in green and blue colors and red shows cell death. The model performance is shown based on (b) state assignment accuracy, (c) the error between the estimated and the true transition rate matrix and the (d) initial probability vector. In (e-f) it shows the accuracy in estimating the Bernoulli parameters for G1 and S/G2 phase, respectively, and (g) depicts the distance between the true and estimated Gamma distributions associated with phase lengths for the two states. Each point in the scatter plots represents the estimated value for a lineage with the number of cells shown in the x-axis. The solid lines are the linear regressions for the scatter points.](./output/figure5.svg){#fig:performSyn}

### Lineage information improves cell state identification

Cells of even very distinct molecular states can have partly overlapping phenotypes. Therefore, we sought to evaluate how different two states would need to be for us to accurately identify them as distinct (Fig. {@fig:wass}a). We varied the G1 phase duration of two states from identical to very distinct (Fig. {@fig:wass}b) and quantified the accuracy of our model. While the phenotypic observation of a given state had to be different for our model to accurately assign cells, even partly overlapping phenotypes could be distinguished by using the lineage relationships of cells (Fig. {@fig:wass}c). As a baseline comparison, we used K-means clustering to cluster cells based on their phenotype without using their lineage relationships (Fig. {@fig:wass}c). A tHMM consistently out-performed this approach.  The model performance in censored and uncensored populations were similar (Fig. @fig:wass1, @fig:wass2). This shows that the heritability of a cell state can be used to more accurately identify cells with partially overlapping phenotypes.

![**Model performance versus the Wasserstein distance between states.** (a) Cartoon of how two states can vary in their phenotypic similarity. (b) The distribution of G1 duration is varied in state 1 (blue) while the other state is kept constant. (c) State assignment accuracy versus the Wasserstein distance between state phenotypes. Each point represents the accuracy of state assignment for a lineage created by a set of parameters that yield the shown Wasserstein distance between the two state distributions, blue points represent the accuracy of K-means clustering which does not take the relationship between the cells into account; orange points represents the accuracy when the lineage is fitted to the tHMM. The solid lines are the linear regressions of the scatter points.](./output/figure6.svg){#fig:wass}

### Likelihood-based model selection can effectively identify the number of distinct states

One does not usually know the number of distinct cell states within a population. Further, the number of distinct states may depend on the environmental context of the cells, particularly because we use phenotypic measurements. To test whether we could infer the number of distinct states, we performed model selection using the Akaike information criterion (AIC) and models with varying numbers of states (Fig. @fig:sAIC). The predicted number of cell states was predominantly correct, and incorrect predictions still centered around the true answer, for both uncensored and censored lineages (Fig. @fig:sAIC). This indicates that model selection can help to identify the appropriate number of cell states for a given set of measurements.

![**Model selection effectively identifies the number of distinct states.** (a)-(d) Model AIC for uncensored lineages with 1–4 states. (e)-(h) Model AIC for censored lineages with 1–4 states. AIC values are normalized such that the optimum is equal to 0. Histograms are shown for the minimal AIC over repeated analyses.](./output/figure8.svg){#fig:sAIC}

### tHMM infers multiple distinct subpopulations in experimental drug response data

We used phenotypic measurements of the G1 and S/G2 phase durations and fates in AU565 cells upon gemcitabine and lapatinib treatment as an application of our model. First, we determined the number of distinct states the model inferred within these populations. Cells were imaged every 30 minutes for 96 hours and then tracked over time. The model was fit to the drug treatment data across all conditions, holding the initial and transition probabilities constant across concentration but allowing the phenotype emissions to independently vary in each condition. The tHMM model inferred different numbers of distinct states for each drug (Fig. {@fig:expAIC}a-b).


![**AIC-based selection inferred the likely number of phenotypically distinct subpopulations.** (a) Normalized AIC values for lapatinib-treated cells. (b) Normalized AIC values for gemcitabine-treated cells. For both drugs the AIC metric was subtracted by the minimum value observed, such that the most likely number of distinct states is equal to 0.](./output/figure9.svg){#fig:expAIC}

### Identified subpopulations own unique properties in drug-treated experimental data

Realizing the most likely number of distinct subpopulations in a data is most valuable when it is accompanied with the quality of each subpopulation. To find out what information each state holds and learning about unique properties of each subpopulation, we plotted the observed measurements for each state, separately. The following two sections discuss our findings for lapatinib and gemcitabine-treated data.

#### tHMM infers fairly stable subpopulations for lapatinib-treated data

To visualize the properties of the states that the model has identified, we plotted the distribution of average phase-specific time duration for each state and each condition. Figs. {@fig:emissionsLPT}a-d accompanied with the transition probability plot (Fig. {@fig:emissionsLPT}i) show that treatment with lapatinib leads to three fairly stable states. As expected, lapatinib mostly influences G1 phase where it extend the duration of this phase in all states (Fig. {@fig:emissionsLPT}e) and leaves G2 progression rates almost unchanged (Fig. {@fig:emissionsLPT}f). This fact could be also observed in Figs. {@fig:emissionsLPT}a-d where green scatters that show cells in G1 phase, cover a wider range and could be as long as 120 hours and more, but G2 phase lengths are mosly condensed centered at ~30-50 hours long. Figs. {@fig:emissionsLPT}g-h show that mostly G1 cell death happens in state 2 and 3, but death in G2 phase is observed as well, in state 1.

![**State-specific emissions of the lapatinib-treated data.** (a-d) Distribution of phase lengths for each state and for each condition in lapatinib-treated cells (control, 25 nM, 50 nM, and 250 nM). Increasing the concentration of lapatinib results in more extension of G1 phase of cells, shown in green scatter points. (e-f) G1 and G2 phase progression rates for different concentrations. Most effects of lapatinib treatment is observed in G1 phase. (g-h) G1 and G2 division probabilities for different concentration. (i) State transition graph showing the probability of state transitions among the three predicted states. Arrows and the corresponding number on top of it shows the transition probability between the two states.](./lineage/figures/cartoons/fig11.svg){#fig:emissionsLPT}

#### Gemcitabine treatment leaves stable and cycle states in the cell population

Increasing the concentration in gemcitabine-treated trials shows a trend of extension and cell death in both phases, especially in G2 (Figs. {@fig:emissionsGMC}a-d). Figs. {@fig:emissionsGMC}e-f show that phase progression in G1 is only evident when the concentration is very high, but cells in all three states have a decline in their G2 progression rate for every concentration. Division probability is shown in Figs. {@fig:emissionsGMC}g-h where we see G1 cell death more significantly in state 1, and G2 cell death in state 2 and 3. From the transition graph (Fig. {@fig:emissionsGMC}i) states 2 and 3 form a cycle while state 1 is fairly stable. Cells in state 1 seem to be slower in G1 progression in any concentration, and have higher G1 cell death probability in the highest concentration. On the other hand, although cells in state 3 have higher probability of cell in G2, but due to the high inward transition probability from state 2, they are not depleted in G2. 

![**State-specific emissions of the gemcitabine-treated data.** (a-d) Distribution of phase lengths for each state and for each condition in gemcitabine-treated cells (control, 5 nM, 10 nM, and 30 nM). (e-f) G1 and G2 progression rates for different concentrations. Cells in state 1 have the highest G1 arrest rate. (g-h) G1 and G2 division probabilities for different concentration. (i) Transition graph showing the probability of state transition between the 3 predicted states within the cells.](./lineage/figures/cartoons/fig12.svg){#fig:emissionsGMC}

