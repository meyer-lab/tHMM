## Results

### Lineage information provides unique information about the source and dynamics of heterogeneity

<!-- ASM proofed. -->

To illustrate the unique value of lineage measurements when analyzing heterogeneous drug responses, we plotted a series of lineages from our measurements of the breast cancer cell line AU565 treated with gemcitabine (Fig. @fig:lineage). While there is a striking difference in the growth dynamics of individual cells, the total number of cells at any given time is nearly identical. As a result, population-level drug response measurements cannot distinguish the differences in these two conditions. Measurements that record the history of cells (e.g., CFSE staining, Luria-Delbruck experiment) can help to distinguish these two populations but must make assumptions about the dynamics of heterogeneity [@DOI:10.1073/pnas.1715639115; @PMID:28607484]. Lineage measurements, by contrast, provide sufficiently rich measurements to quantify the specific structure of heterogeneous response. By observing individual cells, a variety of phenotypic measurements such as inter-mitotic times, cell cycle phase durations, motility, cell death and division, morphology, and protein and transcription factor levels can be characterized in parallel (CITE).

![**Population-based measurements are insufficient to distinguish the structure of heterogeneous populations.**  Selected lineages of AU565 cells (a) untreated or (b) treated with 5 nM gemcitabine. Each line indicates the lifetime of one cell. The line branching into two lines indicates cell division. Both conditions have the same initial and final number of cells. However, the contribution of individual cells to population growth is clearly different. The G1 and S-G2 phase durations are shown in solid thick and thin lines, respectively.](figure1.svg){#fig:lineage}

### A lineage tree-based hidden Markov model infers the state of cells given measurements on lineage trees

<!-- ASM proofed. -->

Given the unique insights that single-cell measurements on lineage trees can provide, we wished to implement a strategy for classifying cells based on their phenotype and relationships. Given a set of measurements made across a lineage tree, we used a lineage tree-based hidden Markov model (tHMM) to fit these data (Fig. {@fig:tree}a). Like a typical hidden Markov model, a tHMM can infer the hidden discrete states of cells given a series of measurements. This takes place using an iterative strategy wherein the states of each cell are predicted given their phenotype and relatives (“expectation” step), and then each distribution of phenotypes is fit to match the cells within that state (“maximization” step) (Fig. {@fig:tree}b). This expectation-maximization (EM) process repeats until convergence.

After fitting, the model can provide a variety of information (Fig. {@fig:tree}c). First, it estimates the starting abundance of each state and the transition probabilities between them. Second, the phenotypes of cells in each state are estimated and can be compared to distinguish how cells of each state behave. The state of each cell can be predicted from the fit data or new measurements. Finally, the model provides a likelihood of each cell’s observations and therefore the data overall. This last quantity can be used, for example, to estimate the number of distinguishable cell states. When implementing these processes, we ensured that a cell’s measurements are defined through a modular interface, allowing other forms of data to be easily integrated.

![**The tHMM interface.** (a) Input data takes the form of single-cell measurements, where the lineage relationship between cells is known. (b) The fitting process includes expectation and maximization steps, where model parameters are iteratively updated until convergence. (c) Output predictions of the model after fitting including the tree of inferred cell states, probabilities of transition between each state, starting abundance of each cell state, and distributions that describe the behavior of cells within each state. The model likelihood can be used to estimate the number of distinguishable cell states.](figure2.svg){#fig:tree}

### Experiments of finite time necessitate experimental censorship corrections

<!-- ASM proofed. -->

Modeling cell growth and therefore the duration of each cell’s lifetime is complicated by the influence of experimental factors. Specifically, cells at the beginning or end of an experiment persist beyond its duration and so, while we observe them, we do not know the duration of their cell cycle phases. Previously, this has been addressed by simply removing incompletely-observed cells [@doi:10.7554/eLife.51002]. However, doing so results in a systematic bias, where longer-lived cells are preferentially eliminated. On the other hand, treating these truncated values like they were not truncated also creates a systematic bias; for example, the experiment duration would become an upper bound on the cells' lifetimes.

To incorporate this effect into our model, we marked cells or their specific cell cycle phase that encountered the bounds of the experiment as such. When estimating the properties of a cell’s lifetime or the probability of a cell’s observation, these cells instead used a censored estimator or the survival function of the distribution (CITE). Using synthetic data, we verified that this correction resulted in accurate phenotype estimations (Fig. @fig:censor). As exhibited, using the censored estimator as opposed to the uncensored model on incompletely-observed cells results in higher cell state assignment accuracy. Thus, taking into account the cells that outlive the bounds of the experiment through a censored model ensures that we can accurately infer cell states despite the contribution of experiment duration.

![**Experiments of finite time necessitate data censorship corrections.** (a) An example, randomly-generated, uncensored two-state lineage. (b) An example, randomly-generated, censored two-state lineage. State 0 and 1 cells are shown in green and blue. (c) State assignment accuracy with censored lineages using an uncensored model. (d) State assignment accuracy with experiment time and cell death-censored lineages. Each scatter point represents the state assignment accuracy of a lineage with the shown cell number that has been fitted to the model. The solid lines refer to the Lowess lines of the scattered data.](figure4.svg){#fig:censor}

### Synthetic lineage benchmarks show a tHMM can accurately estimate population behavior

<!-- ASM proofed. -->

To evaluate how accurately a tHMM model could infer the behavior of multi-state cell populations, we used synthetic populations of cells in a wide variety of configurations. In each case, we determined that our implementation of a tHMM model could accurately infer the hidden states and parameters of a population given roughly 100 cells. This synthetic data included situations that were both not censored (Figs. @fig:uncenSingle, @fig:uncenMulti, @fig:performUncenSingle, @fig:performUncenMulti) and censored due to cell death and experimental duration to be representative of experimental lineages (Figs. @fig:performSyn, @fig:performCenMulti, @fig:cenMulti). In addition to varying the number of cells in a population, we benchmarked populations with varied cell state percentages (Figs. @fig:prop4, @fig:real_5) and varied degrees of phenotypic differences (Figs. @fig:wass1, @fig:wass2, @fig:wass). In total, this benchmarking showed that our tHMM model would provide accurate results across a range of circumstances.

More specifically, one of the benchmarking studies we performed was with data matching our measurements of AU565, where G1 and S/G2 phase periods were quantified (Fig. {@fig:performSyn}a). Although the tHMM model was fit with no information about the true underlying parameters of the simulated cells, it accurately distinguished the two underlying cell states' phenotypes (Fig. {@fig:performSyn}b–d) and member cells (Fig. {@fig:performSyn}e). On the population level, the transition and starting probabilities were accurately estimated (Fig. {@fig:performSyn}f–g). Thus, we are confident that, with similar experimental data, we should derive accurate results.

![**Model performance on censored lineages of increasing breadth and depth.** (a) Two-state populations of increasing breadth (increasing number of initial cells and therefore lineages) and of increasing depth (increasing experiment time) are analyzed. The states are shown in green and blue colors and red shows cell death.  In (b-c) it shows the accuracy in estimating the Bernoulli parameters for G1 and S/G2 phase, respectively, and (d) depicts the distance between the true and estimated Gamma distributions associated with phase lengths for the two states. The model performance is shown based on (e) state assignment accuracy, (f) the error between the estimated and the true transition rate matrix and the (g) initial probability vector. Note that the Wasserstein distance between the true and estimated distributions for each state is much lower than the distance for two distributions that are quite similar (Fig. {@fig:wass}b).Each point in the scatter plots represents the estimated value for a lineage with the number of cells shown in the x-axis. The solid lines are the Lowess lines for the scatter points.](figure5.svg){#fig:performSyn}

### Lineage information improves cell state identification for heritable phenotypes

<!-- ASM proofed. -->

Cells of even very distinct molecular states can have partly overlapping phenotypes due to non-heritable variation. Therefore, we sought to evaluate how different two states would need to be for us to accurately identify them as distinct (Fig. {@fig:wass}a). We varied the G1 phase duration of two states from identical to very distinct (Fig. {@fig:wass}b) and quantified the accuracy of our model. While the phenotypic observation of a given state had to be different for our model to accurately assign cells, even partly overlapping phenotypes could be distinguished by using the lineage relationships of cells (Fig. {@fig:wass}c). As a baseline comparison, we used K-means clustering to cluster cells based on their phenotype without using their lineage relationships (Fig. {@fig:wass}c). A tHMM consistently out-performed this approach.  The model performance in censored and uncensored populations were similar (Fig. @fig:wass1, @fig:wass2). This shows that the heritability of a cell state can help to more accurately identify cells with partially overlapping phenotypes.

![**Model performance versus the Wasserstein distance between states.** (a) Cartoon of how two states can vary in their phenotypic similarity. On the left, cells might be virtually indistinguishable (here based on shape). On the right, they might be so different that looking at one cell is sufficient to identify its state. (b) The distribution of G1 duration is varied in state 1 (blue) while the other state is kept constant. (c) State assignment accuracy versus the Wasserstein distance between state phenotypes. Each point represents the accuracy of state assignment for a lineage created by a set of parameters that yield the shown Wasserstein distance between the two state distributions. Either a k-means model was used with the phenotypes of each individual cell (orange) or the full tHMM model was applied (blue). The solid lines show a Lowess trendline of the model accuracy.](figure6.svg){#fig:wass}

### Likelihood-based model selection can effectively identify the number of distinct states

One does not usually know the number of distinct cell states within a population. Further, the number of distinct states may depend on the environmental context of the cells, particularly because we use phenotypic measurements [@doi:10.1371/journal.pgen.1008458; @doi:10.1098/rsif.2017.0141]. To test whether we could infer the number of phenotypically-distinct states, we performed model selection using the Bayesian information criterion (BIC) while varying the number of states in synthetic data (Fig. @fig:sBIC). The predicted number of cell states was predominantly correct, and incorrect predictions still centered around the true answer, for both uncensored and censored lineages (Fig. @fig:sBIC). This indicated that model selection can help to identify the appropriate number of cell states for a given set of measurements.

![**Model selection effectively identifies the number of distinct states.** (a)-(d) Model BIC for uncensored lineages with 1–4 states. (e)-(h) Model BIC for censored lineages with 1–4 states. BIC values are normalized such that the optimum is equal to 0. Histograms are shown for the minimal BIC over 10 repeated analyses.](figure8.svg){#fig:sBIC}

### tHMM infers multiple distinct subpopulations in experimental drug response data

As an application of our model, we used phenotypic measurements of the G1 and S/G2 phase durations and cell fates at the end of each phase in AU565 cells in control condition and when they are treated with 3 concentrations of gemcitabine and lapatinib. We imaged cells every 30 minutes for 96 hours and then tracked over time to assemble their lineage relationships. The lapatinib and gemcitabine-treated populations contained a total of 5290 and 4537 cells, respectively, where the lineages had between 1 to 5 generation of cells. The model was fit to each drug treatment data across all conditions, holding the initial and transition probabilities constant across concentrations while allowing the phenotype emissions to independently vary in each condition. We assessed the likelihood of the model for 1, 2, 3, ..., 8 states, separately, using the Bayesian Information Criteroin (BIC). The number of states that corresponds to the lowest value of the BIC determines the best fit; however, each cell can essentially define its own state and if we allow it, we may end up with hundreds of states. That is why we need to find an optimum number of states, like an elbow in the curve, such that the BIC value does not significantly change with more number of states. Hence, we decicded to choose 3 as the determined number of states for both lapatinib and gemcitabine treated populations (Fig. {@fig:expBIC}a-b). 

![**BIC-based model selection infers the likely number of phenotypically distinct subpopulations.** Normalized BIC values for (a) cells in control and treated with 5 nM, 25 nM, and 250 nM of lapatinib and (b) cells in control and treated with 5 nM, 10 nM, and 30 nM of gemcitabine. For both drugs, the BIC values for all conditions were normalized to zero based on the minimum value.](figure9.svg){#fig:expBIC}

### Lapatinib treatment leaves stable and cyclical states in the cell population

We fitted the lapatinib treated data to the model with 3 states, based on BIC analysis (Fig. {@fig:expBIC}a). As a result of fitting, the population was classified into one stable state (state 2) and a cycle (states 1 and 3) (Fig. {@fig:emissionsLPT}i). To display the properties of the population classes, we plotted the distribution of the average phase-specific time durations for each state and each condition (Figs. {@fig:emissionsLPT}a-d). Looking across conditions, it appears that in all states, G1 phases are extended in higher concentrations (Fig. {@fig:emissionsLPT}e) and that cells in state 1 are depleted at 250 nM treatment (Fig. {@fig:emissionsLPT}d, Fig. {@fig:LapatinibTree}) which is either due to transition to state 3, or cell death. Cells in state 2 (orange) form a stable subpopulation and rarely transition to other states, while some cells in state 3 (green) transition to state 1 (blue) and vice versa. Additionally, fast-growing cells in state 1 (Fig. {@fig:emissionsLPT}i and Fig. {@fig:LapatinibTree}a) seem to be more drug-sensitive, as opposed to cells in state 2. As expected, we see that lapatinib leaves the mean of G2 times (i.e. shape $\times$ scale parameter) almost unchanged (Fig. {@fig:emissionsLPT}f) and that these cells do not usually undergo cell death, except for 250 nM treatment (Figs. {@fig:emissionsLPT}g-h). Cells in their G1 phase cover a wider range and can be as long as 90 hours, but G2 phase lengths are densely centered at ~20-30 hours long (Figs. {@fig:emissionsLPT}a-d). Cell death at G1 phase mostly happens in state 2 and cell death in the G2 phase is observed in state 3 (Figs. {@fig:emissionsLPT}g-h G1). Further, it appears that cells with almost no cell death traits are accumulated in state 1.

![**State-specific emissions of the lapatinib-treated data.** (a-d) Distribution of phase lengths for each state and for each condition in lapatinib-treated cells (control, 25 nM, 50 nM, and 250 nM). Increasing the concentration of lapatinib results in extended G1 phase durations, shown in green scatter points. (e-f) mean time of G1 and G2 phase for different concentrations. Most effects of lapatinib treatment is observed in G1 phase. (g-h) Probability switching states or dividing versys dying in the G1 and G2 phase for different concentrations. (i) State transition graph showing the probability of state transitions among the three predicted states.](figure11.svg){#fig:emissionsLPT}

### tHMM identifies stable subpopulations in gemcitabine-treated populations

The identified classes in the gemcitabine-treated population show stability in all 3 states (Fig. {@fig:emissionsGMC}i, @fig:GemcitabineTree). Increasing the concentration of gemcitabine causes a trend of phase length extension and cell death in both phases, especially in G2 (Figs. {@fig:emissionsGMC}a-d) and a significant decrease in the G1 phase progression for high concentrations of gemcitabine (Figs. {@fig:emissionsGMC}e-f). Further, cells in all three states have a drop in their mean time of G2 phase for every concentration, especially cells in state 3, which are significantly arrested in both phases and show a higher probability of cell death at the end of their G2 phase. Despite the stability of the states, the difference in the growth rates of cells in different classes determines variability in the abundance of cells in these states over time.

![**State-specific emissions of the gemcitabine-treated data.** (a-d) Distribution of phase lengths for each state and for each condition in gemcitabine-treated cells (control, 5 nM, 10 nM, and 30 nM). (e-f) mean time of G1 and G2 phase for different concentrations. Cells in state 1 have the highest G1 phase mean time. (g-h) G1 and G2 division probabilities for different concentration. (i) Transition graph showing the probability of state transition between the 3 predicted states within the cells.](figure12.svg){#fig:emissionsGMC}
