## Results

### Lineage information provides unique information about the source and dynamics of intratumoral heterogeneity

<!-- ASM proofed. -->

Single cells, in turn, grow and divide into two daughter cells and form a binary genealogical tree, also known as a lineage, from a single ancestor. To maintain the relationship between the cells, we collected the single-cell measurements in the form of lineage trees. The life cycle of each cell before division includes phases that have to pass one after another. Cell division is allowed upon a successful passage from checkpoints at each cell cycle phase. To illustrate the unique value of lineage measurements in analyzing intra-tumoral and drug response heterogeneity, we plotted two sets of sample lineages from measurements of the breast cancer cell line AU565 (Fig. @fig:lineage a-b). The single cell lineages reveal a striking difference in cell cycle phase durations and cell division dynamics between the two samples. Population-level measurements, on the other hand, would be unable to identify this difference as the starting and ending cell numbers are not different. Measurements that record the history of cells (e.g., CFSE staining, Luria-Delbruck experiment) can help to identify these variations within cell populations but must make assumptions about the dynamics of heterogeneity [@DOI:10.1073/pnas.1715639115; @PMID:28607484]. Lineage measurements, by contrast, provide sufficiently rich temporal information to quantify the specific structure of the phenotypic heterogeneity. 

As a further exploration of the data, we randomly sampled lineages from the gemcitabine-treated cells (Fig. @fig:lineage c). Gemcitabine is a chemotherapy agent that disrupts DNA replication and results in extension of and apoptosis in S phase [@PMID:8431926]. The S/G2 phase lengths in treated cells are noticeably extended compared to control cells, and cell division is diminished. Individual lineages show striking variation, including anywhere from zero to three cell divisions, but tightly shared behavior among cells and their close relatives. By observing individual cells, a variety of phenotypic measurements such as inter-mitotic times, cell cycle phase durations, motility, cell death and division, morphology, and protein and transcription factor levels can be characterized in parallel [@doi:10.1126/science.abc1944].

![**Total cell number is insufficient to distinguish the structure of heterogeneous populations.** (a/b) Selected lineages of untreated AU565 cells. (c) Randomly selected lineages of AU565 cells treated with 5 nM gemcitabine. Each line indicates the lifetime of one cell. The line branching into two lines indicates cell division. The G1 and S/G2 phase durations are shown in solid thick and thin lines, respectively.](figure1.svg){#fig:lineage}

### A lineage tree-based hidden Markov model infers the state of cells given measurements on lineage trees

<!-- ASM proofed. -->

Given the unique insights that single cell measurements on lineage trees can provide, we implemented a strategy for classifying cells based on their phenotype and lineage relationships. We used a lineage tree-based hidden Markov model (tHMM) to fit a set of measurements made across a lineage tree (Fig. {@fig:tree}a). Like a typical hidden Markov model, a tHMM can infer the hidden discrete "states" of cells given a series of measurements where a state is defined by specific phenotype distributions. The inference of these states takes place using an iterative strategy wherein the states of each cell are predicted by the phenotype of both the cell and its relatives in a lineage ("expectation" step), and then each distribution of phenotypes is fit to match the cells within that state ("maximization" step) (Fig. {@fig:tree}b). This expectation-maximization (EM) process repeats until convergence.

After fitting, the model can provide a variety of information (Fig. {@fig:tree}c). First, it infers the starting and transition probabilities of each state. Second, the distribution of cells’ phenotypes in each state are estimated and can be compared to distinguish how cells of each state behave. For instance, if we use the growth rates of cells as their phenotype, we may observe a subpopulation of cells with shorter times to division, and another with longer times. Moreover, the state of each individual cell can be predicted from the fit data or new measurements. Finally, the model provides a likelihood of each cell’s observations and therefore the data overall. This last quantity can be used, for example, to estimate the number of distinguishable cell states. When implementing these processes, we ensured that a cell’s measurements are defined through a modular interface, allowing other forms of data to be easily integrated.

![**The tHMM interface.** (a) Input data takes the form of single cell measurements across time, where the lineage relationship between cells is known. (b) The fitting process includes expectation and maximization steps, where model parameters are iteratively updated until convergence. (c) Output predictions of the model after fitting including the tree of inferred cell states, probabilities of transition between each state, starting abundance of each cell state, and distributions that describe the behavior of cells within each state. The model likelihood can be used to estimate the number of distinguishable cell states.](figure2.svg){#fig:tree}

### Experiments of finite time necessitate corrections for experimental censorship

<!-- ASM proofed. -->

The phenotypic measurements used in this study, either synthetic or experimental, were in the form of cell lifetime and fate. Modeling the duration of each cell’s lifetime is complicated by the influence of experimental parameters. Specifically, cells at the beginning or end of an experiment persist beyond its duration and so, while we observe them, we do not know their exact duration. Previously, this has been addressed by simply removing incompletely observed cells [@doi:10.7554/eLife.51002]. However, doing so results in a systematic bias, where longer-lived cells are preferentially eliminated. On the other hand, ignoring the truncation of these values also creates a systematic bias; by creating an upper bound on the cells’ lifetimes.

To correct for this effect in our model, we marked cells that encountered the start or end bounds of the experiment. When estimating the properties of a cell’s lifetime or the probability of a cell’s survival versus death for these cells we instead used a censored estimator or the survival function of the distribution [@gamma_paper]. Using synthetic data, we verified that this correction resulted in accurate phenotype estimations of 95% or higher (Figs. @fig:censor, @fig:cenMulti, @fig:performCenMulti). As shown, using the censored estimator as opposed to the uncensored model on incompletely observed cells results in higher cell state assignment accuracy. Thus, taking into account the cells that outlive the bounds of the experiment through a censored model ensures that we can accurately infer cell states despite the contribution of experiment duration.

![**Experiments of finite time necessitate data censorship corrections.** (a) An example, synthetic, uncensored two-state lineage. (b) An example, synthetic, censored two-state lineage. State 0 and 1 cells are shown in green and blue. (c) State assignment accuracy with censored lineages using an uncensored model. (d) State assignment accuracy with experiment time and cell death-censored lineages. Each scatter point represents the state assignment accuracy of a lineage with the shown cell number that has been fitted to the model. The solid lines show the Lowess trendline of the individual run accuracies.](figure4.svg){#fig:censor}

### Synthetic lineage benchmarks show a tHMM can accurately estimate population behavior

<!-- ASM proofed. -->

To evaluate how accurately a tHMM model could infer the behavior of multi-state cell populations, we used synthetic populations of cells in a wide variety of configurations, such as various populations sizes, abundance of the present states, etc. In each case, we determined that our implementation of a tHMM model could accurately infer the hidden states and parameters of a population given at least 100 cells. This synthetic data included situations that were both not censored (Figs. @fig:uncenSingle, @fig:uncenMulti, @fig:performUncenSingle, @fig:performUncenMulti) and censored due to cell death and experimental duration to be representative of experimental lineages (Figs. @fig:performSyn, @fig:performCenMulti, @fig:cenMulti). In addition to varying the number of cells in a population, we benchmarked populations with varied cell state percentages (Figs. @fig:prop4, @fig:real_5) and varied degrees of phenotypic differences (Figs. @fig:wass1, @fig:wass2, @fig:wass). This benchmarking consistently showed that the tHMM model would provide accurate results across a range of circumstances.

More specifically, one of the benchmarking studies we performed was with data matching our measurements of AU565, where G1 and S/G2 phase durations, represented by a Gamma distribution, and their corresponding cell fate, represented by a Bernoulli distribution, were quantified (Fig. {@fig:performSyn}). Although the tHMM model was fit with no information about the true underlying parameters of the simulated cells, it distinguished the pre-assigned two underlying cell states' phenotypes (Fig. @fig:performSyn b–d) and member cells with more than 95% accuracy (Fig. {@fig:performSyn}e). The Wasserstein distance metric was used to represent the difference between the true and estimated Gamma distributions to show the accuracy of parameter estimation (Fig. @fig:performSyn d). On the population level, the distance between the true and estimated transition probabilities calculated by the Frobenius norm was less than 0.1 for 100 cells or more. Starting probabilities were compared to their corresponding true values in terms of Euclidean distance and showed less than a 0.2 error for populations with 10 lineages or more (Fig. {@fig:performSyn}f–g). Thus, we are confident that with similar experimental data, we should derive accurate results.

![**Model performance on censored lineages of increasing breadth and depth.** (a) Two-state populations of increasing breadth (increasing number of initial cells and therefore lineages) and of increasing depth (increasing experiment time) are analyzed. The states are shown in green and blue colors and red shows cell death. Each point in the scatter plots represents the inferred value for a model evaluation trial with the number of cells shown in the x-axis. The solid lines are the Lowess trendline across the individual trials. The accuracy in estimating the Bernoulli parameters for G1 and S/G2 phase, respectively, is shown in (b-c). The distance between the true and estimated Gamma distributions associated with phase lengths for the two states is depicted in (d). The model performance is also evaluated based on the state assignment accuracy (e), the error between the estimated and the true transition rate matrix (f), and the initial probability vector (g). Note that the Wasserstein distance between the true and estimated distributions for each state is much lower than the distance between two distributions that are quite similar (Fig. {@fig:wass}b).](figure5.svg){#fig:performSyn}

### Lineage information improves cell state identification with heritable phenotypes

<!-- ASM proofed. -->

Cells of even very distinct molecular states can have partly overlapping phenotypes due to non-heritable variation. Therefore, we sought to evaluate how different two states would need to be for us to accurately identify them as distinct (Fig. {@fig:wass}a). We varied the G1 phase duration of two states from identical to very distinct (Wasserstein distance greater than 70) (Fig. {@fig:wass}b) and quantified the accuracy of our model. While the phenotypic observation of a given state had to be different for our model to accurately assign cells, even moderately overlapping phenotypes could be distinguished by using the lineage relationships of cells (Fig. {@fig:wass}c). As a baseline comparison, we used K-means clustering to cluster cells based on their phenotype without using their lineage relationships (Fig. {@fig:wass}c). A tHMM consistently outperformed this approach.  The model performance in censored and uncensored populations were similar (Fig. @fig:wass1, @fig:wass2). This shows that the heritability of a cell state can help to more accurately identify cells with partially overlapping phenotypes.

![**Model performance versus the Wasserstein distance between states.** (a) Cartoon of how two states can vary in their phenotypic similarity. Cells in state 2, shown in green, might be virtually indistinguishable (here based on shape) as a pposed to cells in state 1, shown in blue, might be so different that looking at one cell is sufficient to identify its state. (b) The distribution of G1 duration is varied in state 1 (blue) while the other state is kept constant. (c) State assignment accuracy versus the Wasserstein distance between state phenotypes. Each point represents the accuracy of state assignment for a lineage created by a set of parameters that yield the shown Wasserstein distance between the two state distributions. Either a K-means model was used with the phenotypes of each individual cell (orange) or the full tHMM model was applied (blue). The solid lines show a Lowess trendline of the model accuracy.](figure6.svg){#fig:wass}

### Likelihood-based model selection can effectively identify the number of distinct states

<!-- ASM proofed. -->

One does not usually know the number of distinct cell states within a population. Further, the number of distinct states may depend on the environmental context of the cells, particularly because we use phenotypic measurements [@doi:10.1371/journal.pgen.1008458; @doi:10.1098/rsif.2017.0141]. To test whether we could infer the number of phenotypically-distinct states, we performed model selection using the Bayesian information criterion (BIC) while varying the number of states in synthetic data (Fig. @fig:sBIC). We normalized the BIC values such that zero corresponds to the state with the highest likelihood. The synthetic populations that were used included approximately 250 to 650 cells with known cell phase fate and phase lengths. The predicted number of cell states was correct, and the few incorrect predictions still centered around the true answer, for both uncensored and censored lineages (Fig. @fig:sBIC). This indicated that model selection can help to identify the appropriate number of cell states for a set of measurements.

![**Model selection effectively identifies the number of distinct states.** (a)-(d) Model BIC for uncensored lineages with 1–4 states. (e)-(h) Model BIC for censored lineages with 1–4 states. BIC values are normalized such that the optimum is equal to 0. Histograms are shown for the minimal BIC over 10 repeated analyses.](figure8.svg){#fig:sBIC}

### tHMM infers multiple distinct subpopulations in experimental drug response data

<!-- ASM proofed. -->

As an application of our model, we used phenotypic measurements of the G1 and S/G2 phase durations and terminal cell fates of AU565 cells in a control condition and when treated with 3 concentrations of gemcitabine and lapatinib. We imaged cells every 30 minutes for 96 hours and then tracked them over time to assemble their lineage relationships. The lapatinib and gemcitabine-treated populations including control contained a total of 5290 and 4537 cells, respectively, with lineages that had 1–5 generations of cells. The model was then fit to each drug's data across all conditions, holding the initial and transition probabilities constant across concentrations while allowing the phenotype emissions to vary. We forced the duration shape parameter to be shared and the scale parameters to vary monotonically with drug concentration. The Bernoulli cell fate parameters were estimated without constraints. We compared models of 1–7 states using the BIC, where the lowest BIC value across numbers of states indicates the optimal model correcting for complexity (Fig. {@fig:expBIC}a-b). The data for each compound indicated the presence of multiple inherited states.

![**BIC-based model selection infers the likely number of phenotypically distinct subpopulations.** Normalized BIC values for (a) cells in control and treated with 5 nM, 25 nM, and 250 nM of lapatinib and (b) cells in control and treated with 5 nM, 10 nM, and 30 nM of gemcitabine. For both drugs, the BIC values for all conditions were normalized to zero based on the minimum value.](figure9.svg){#fig:expBIC}

### Lapatinib treatment leaves stable and cyclical states in the cell population

<!-- ASM proofed. -->

We fitted the lapatinib treated data to the model with 6 states based on our BIC-based model selection (Fig. {@fig:expBIC}a). Fitting revealed states of widely varying persistence over generations, from a 0.02 probability of remaining in state 6 to a 0.91 probability of remaining in state 2 (Fig. {@fig:emissionsLPT}a). Interestingly, state 5 and 6 formed a cycle, wherein the most probable transition was between these two states (Fig. {@fig:emissionsLPT}a).

Examining the phenotypes of each state revealed distinct drug responses. Lapatinib is a EGFR/HER2 inhibitor that induces cell cycle arrest in G1 phase [@doi:10.4161/cc.25728]. Every state showed an increase in G1 phase lifetimes, and states were most distinct in their G1 durations (Figs. {@fig:emissionsLPT}b-f, @fig:LapatinibTree). State 4 showed the most drastic response to treatment, going from one of the fastest-growing states to most arrested (Fig. {@fig:emissionsLPT}b,d,f). In contrast to G1 phase, there was almost no change in the mean S/G2 duration except for cells in state 5 (Fig. {@fig:emissionsLPT}g). The probability of cell death in G1 phase was higher in state 2 and 3, and in S/G2 phase, only cells in state 3 had a chance of cell death (Figs. {@fig:emissionsLPT}h-i). Cell death appeared only at the highest concentrations of lapatinib. States were separated based on whether they responded to drug treatment with cell death or phase duration extension. For example, states 2 and 3 had the highest probabilities of cell death in G1 phase, but also the shortest duration (Figs. {@fig:emissionsLPT}f-i). This likely reflects differences in the dynamics of death versus cell cycle progression outcomes.

![**State-specific emissions of the lapatinib-treated data.** (a) State transition graph showing the probability of state transitions among the three predicted states. (b-e) Lineage trees after fitting the model and state assignment (control, 25 nM, 50 nM, and 250 nM). (f-g) The log10 of fit mean time of G1 and S/G2 phase durations for different concentrations. Most effects of lapatinib treatment is observed in G1 phase. (h-i) Probability of dividing versus dying in the G1 and S/G2 phase for different concentrations.](figure11.svg){#fig:emissionsLPT}

### tHMM identifies more stable states in gemcitabine-treated populations

<!-- ASM proofed. -->

Gemcitabine, as mentioned previously, is a chemotherapy agent that induces cell cycle phase extension and apoptosis in S phase by disrupting DNA repair. The AU565 cells were treated with 5 nM, 10 nM, and 30 nM of gemcitabine, and model selection inferred 5 states in the population (Fig. {@fig:expBIC}b). Examining the 5-state fit revealed relatively stable states 1, 3, and 4 (Fig. {@fig:emissionsGMC}a–e, @fig:GemcitabineTree). States 2 and 5 had higher rates of transition between one another in a partial cycle.

The phenotypic effects of drug treatment were evident in both cell cycle phases, though most prominently in S/G2 phase, where the phase duration of states 2 and 4 doubled (Fig. {@fig:emissionsGMC}f,g). States 2 and 4 were also similar in having a dose-dependent decrease in their survival at the end of S/G2 phase, but few effects in G1 phase (Fig. {@fig:emissionsGMC}h-i). Interestingly, one state, state 1, maintained a normal growth rate at even the highest concentration of gemcitabine, but with higher rates of cell death clearly evident in the lineages themselves (Fig. {@fig:emissionsGMC}a,f,i; @fig:GemcitabineTree). In total, the tHMM model was effective in identifying subsets of cells with divergent phenotypic responses to drug treatment alongside the relationships between cells in the population.

![**State-specific emissions of the gemcitabine-treated data.** (a) State transition graph showing the probability of state transitions among the three predicted states. (b-e) Lineage trees after fitting the model and state assignment (control, 5 nM, 10 nM, and 30 nM). (f-g) The log10 fit mean time of G1 and S/G2 phase durations for different concentrations. (h-i) Probability of dividing versus dying in the G1 and S/G2 phase for different concentrations.](figure12.svg){#fig:emissionsGMC}
