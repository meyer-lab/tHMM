## Materials and Methods

### Data and Software Availability

All analysis and data were implemented in Python v3.8 and can be found at <https://github.com/meyer-lab/tHMM>.

### Experimental cell lineage data

Stable cell line creation, drug treatments, and cell tracking were performed as previously described [@DOI:10.1101/2020.07.24.219907]. Briefly, AU565 cells were co-transfected with a transposase plasmid (Addgene #34879) and a donor plasmid that drove expression of a nuclear localized mCherry, puromycin resistance, and a fragment of HDHB fused to the clover fluorescent protein, which was used to track cell cycle progression. Cells stably expressing the nuclear and cell cycle reporter were selected for 7 days with 0.75 Âµg/ml. To track drug responses AU565 reporter cells were plated into 24-well plates with fluorobrite media containing 10% FBS glutamine, and penicillin-streptomycin. Then 24 hours later fresh media containing escalating doses of lapatinib and gemcitabine were added. After drug addition, plates were placed in the IncuCyte S3 and four image locations per treatment were imaged every 30 minutes for 96 hours. At 48 hours fresh media and drugs were added. Cell lineages from the IncuCyte images were manually tracked in FIJI [@doi:10.1016/B978-0-12-391857-4.00009-4] in order to record cell division, death, and the transition from G1 to S phase. Three biological replicates were collected and combined in the final data set.

### Lineage tree-based hidden Markov model

The core assumption of a Markov chain is that the next state and current observations are only dependent on the current state. Proof of many of the expressions below can be found in Durand et al [@doi:10.1109/TSP.2004.832006]. The tHMM is composed of several intermediate steps to carry out predictions and estimations.

#### Basic model structure

The initial probabilities of a cell being in state $k$ are represented by the vector $\pi$ that sums to 1:  
$$\pi_k = P(z_1 = k), \qquad k \in \{1, ..., K\}$$  
where $z$ shows the states and $K$ is the total number of states. The probability of state $i$ transitioning to state $j$ is represented by the $K \times K$ matrix, $T$, in which each row sums to 1:   
$$T_{i,j} = T(z_i \rightarrow z_j) = P(z_j \;| z_i), \qquad i,j \in \{1, ..., K\}$$  
The emission likelihood matrix, $EL$, is based on the cell observations. It is defined as the probability of an observation conditioned on the cell being in a specific state:  
$$EL(n,k) = P(x_n = x | z_n = k)$$
where $x_n$ shows the cell number $n$, with a total of $N$ cells in a lineage. Separate observations were assumed to be independent; for instance, cell fate is considered to be independent from the time duration of each cell phase. This faciliatates calculating the likelihood of observations, such that we multiply the likelihood of all observations together for the total likelihood.

Since the hidden states are unobserved, we need an expectation-maximization (EM) algorithm, for HMMs called the Baum-Welch algorithm, to find the states and their specifications. The EM algorithm consists of two steps: (1) the expectation step (E-step) and (2) maximization step (M-step.) In the E-step, given the whole lineage tree the probability of a cell and its parent being in specific states are calculated, such that for every cell and every state we have $P(z_n = k \;| X_n) \label{E1}$ and $P(z_n = k,\; z_{n+1} = l \; | X_n) \label{E2}$. The E-step is calculated by the upward and downward recursion algorithms.

In the M-step, the distribution parameters of each state, the initial ($\pi$) probabilities, and the transition probability ($T$) matrices are estimated, given the state assignments of each cell. During fitting we switch between the E-step and the M-step and calculate the likelihood. If the likelihood stops improving below some threshold we take that to indicate that convergence has been reached. The following explains each step in detail.

#### E-step
##### Upward recursion

An _upward-downward_ algorithm for calculating the probabilities in hidden Markov chains (HMCs) was previously proposed by Erphaim and Merhav [@doi:10.1109/TIT.2002.1003838] which suffered from the underflow problem. This problem was originally solved by Levinson [@doi:10.1002/j.1538-7305.1983.tb03114.x] for HMCs, where they adopted a heuristic based scaling, and then was improved by Devijver [@devijver] where they introduced smooth probabilities. Durand et al., [@doi:10.1109/TSP.2004.832006] however, revised this approach for hidden Markov trees to avoid underflow when calculating $P(Z|X)$ probability matrices. To explain that, we need to know the following definitions:

- $p(n)$ is noted as the parent cell of the cell $n$, and $c(n)$ is noted as children of cell $n$.
- $\bar{X}$ is the observation of the whole tree and $\bar{X}_a$ is a subtree of $\bar{X}$ which is rooted at cell $a$.
- $\bar{Z}$ is the complete hidden state tree.
- $\bar{X}_{a/b}$ is the subtree rooted at $a$ except for the subtree rooted at cell $b$, if $\bar{X}_b$ is a subtree of $\bar{X}_a$.

For the state prediction we start by calculating the marginal state distribution (MSD) matrix. MSD is an $N \times K$ matrix that for each cell is marginalizing the transition probability over all possible current states by traversing from root to leaf cells:  
$$MSD(n,k) = P(z_{n} = k)= \sum_{i} P(z_n = k |z_{n-1} = i)\times P(z_{n-1} = i)$$

During upward recursion, the flow of upward probabilities is calculated from leaf cells to the root cells generation by generation. For leaf cells, the probabilities ($\beta$) are calculated by:  
$$\beta(n,k) = P(z_n = k\;|X_n = x_n) = \frac{EL(n,k) \times MSD(n,k)}{NF_l(n)}$$

in which $X_n$ is the leaf cell's observation, and NF (Normalizing Factor) is an $N \times 1$ matrix that is the marginal observation distribution. Since $\sum_{k} \beta_n(k) = 1$, we find the NF for leaf cells using:  
$$NF_l(n) = \sum_{k} EL(n,k) \times MSD(n,k) = P(X_n = x_n)$$

For non-leaf cells the values are given by:  
$$ \beta(n,k) = P(z_n = k\;|\bar{X}_n = \bar{x}_n) = \frac{EL(n,k) \times MSD(n,k) \times \prod_{v \in c(n)}\beta_{n,v}(k)}{NF_{nl}(n)}$$

where we calculate the non-leaf NF using:  
$$NF_{nl}(n) = \sum_{k} \Big[EL(n,k) \times MSD(n,k) \prod_{v \in c(n)} \beta_{n,v}(k)\Big]$$

and linking $\beta$ between parent-daughter cells is given by:  
$$ \beta_{p(n), n}(k) = P(\bar{X}_n = \bar{x}_n | z_{p(n)} = k) = \sum_{j} \frac{\beta_n(j) \times T_{k,j}}{MSD(n,j)}$$

By recursing from leaf to root cells, the $\beta$ and NF matrices are calculated as upward recursion. The NF matrix gives a convenient expression for the log-likelihood of the observations. For each root cell we have:

$$P(\bar{X} = \bar{x}) = \prod_{n} \frac{P(\bar{X}_n = \bar{x}_n)}{\prod_{v\in c(n)} P(\bar{X}_v = \bar{x}_v)} = \sum_{n} NF(n) \qquad n \in \{1, ..., N\}$$

The overall model log-likelihood is given by the sum over root cells:

$$log P(\bar{X} = \bar{x}) = \sum_{n} log NF(n)$$

This quantity acts as the convergence measure of the EM algorithm.

##### Downward recursion

For computing _downward recursion_, we need the following definition for each root cells:

$$ \gamma_1(k) = P(z_1 = k | \bar{X}_1 = \bar{x}_1) = \beta_1(k)$$

The other cells follow in an $N \times K$ matrix by writing the conditional probabilities as the summation over the joint probabilities of parent-daughter cells:

$$\gamma_n(k) = P(z_n = k | \bar{X}_1 = \bar{x}_1) = \frac{\beta_n(k)}{MSD(n,k)} \sum_{i}\frac{T_{i,k} \gamma_{p(n)}(i)}{\beta_{p(n),n}(i)}$$

##### Viterbi algorithm

Given a sequence of observations in a hidden Markov chain, the Viterbi algorithm is commonly used to find the most likely sequence of states. Equivalently, here it returns the most likely sequence of states of the cells in a lineage tree using upward and downward recursion [@doi:10.1109/TSP.2004.832006].

Viterbi follows an upward recursion from leaf to root cells. We define $\delta$, an $N \times K$ matrix:

$$\delta (n,k) = \max\limits_{\bar{z}_{c(n)}}\{P(\bar{X}_n = \bar{x}_n, \bar{Z}_{c(n)} = \bar{z}_{c(n)} | z_n = j)\}$$

and the links between parent-daughter cells as:

$$\delta_{p(n),n}(k) = \max\limits_{\bar{z}_n} \{P(\bar{X}_n = \bar{x}_n, \bar{Z}_n = \bar{z}_n | z_{p(n)} = j)\} = \max\limits_{j}\{\delta(n,j) T_{k,j}\}$$

We initialize from the leaf cells as:

$$\delta(n,k) = P(X_n = x_n | z_n = k) = EL(n,k)$$

and for non-leaf cells use:

$$\delta(n,k) = \Big[\prod_{v \in c(n)} \delta_{n,v}(k)\Big]\times EL(n,k)$$

The probability of the optimal state tree corresponding to the observations tree, assuming root cell is noted as cell 1, is then given by:

$$Z^* = \max\limits_{k}\{\delta(1,k) \pi_k \}$$

which arises from maximization over the conditional emission likelihood (EL) probabilities by factoring out the root cells as the outer maximizing step over all possible states.

#### M-step

In the M-step, we find the maximum likelihood of the hidden Markov model distribution parameters. We estimate the initial probabilities, the transition probability matrix, and the parameters of the observation distributions. The maximum likelihood estimation of the initial probabilities can be found from each state's representation in the root cells:  
$$ \pi^*_k = \gamma_1(k)$$
Similarly, the transition probability matrix is estimated by calculating the prevalence of each transition across the lineage trees:  
$$ T^*_{i,j} = \frac{\sum_{n=1}^{N-1} \xi_n(i,j)}{\sum_{n=1}^{N-1} \gamma_n(i)} $$

#### Estimating distribution parameters

In the current study, we used two distributions; first, a Bernoulli distribution for the probability of cell fate, either at the end of each phase, or at the end of cell's lifetime; second, a Gamma distribution for cell's phase lengths, or lifetime. To estimate the distribution parameters after finding the most likely state for each cell, we group them and their observations by their estimated state and calculate their maximum likelihood estimation. The experimental data includes measurements of cell fate and G1 and S/G2 phase lengths for lapatinib treatement with 25, 100, and 250 nM and for gemcitabine treatment with 5, 10, and 30 nM. By fitting the lineage data of each condition we would get a set of estimated parameters for the distribution of phase lengths and fate for each cell state.

For estimating the Bernoulli distribution parameter for cell fate we simply find the sample mean of the observations for each state. Assuming we have $N_1$ data points estimated in state 1, the corresponding Bernoulli distribution parameter for state 1 would be:

$$ p^*_1 = \frac{\sum_{i=1}^{N_1} x_b(i)}{N_1}$$

And for Gamma distribution parameters we use a closed-form estimation [@gamma] which has been corrected for bias:  
$$ a^* = \frac{N_1 \times  \sum_{i=1}^{N_1} x_g(i)}{\Big[N_1 \times \sum_{i=1}^{N_1} x_g(i) ln(x_g(i))\Big] - \sum_{i=1}^{N_1} ln(x_g(i)) \times \sum_{i=1}^{N_1} x_g(i)} $$
$$ s^* = \frac{1}{N_1^2} \times \Big[N_1 \times \sum_{i=1}^{N_1} x_g(i) ln(x_g(i)) - \sum_{i=1}^{N_1} ln(x_g(i)) \times \sum_{i=1}^{N_1} x_g(i) \Big]$$

The shape and scale parameter from the gamma-distributed phase lengths are representations of the number of and the progression rate through the subphases, and since all the data is collected from one specific cell line, we assumed the number of subphases do not change from one condition to another. Hence, to look at the pattern of parameter change across different conditions, we decided to fit all the conditions simultaneously instead of one by one, to fix the shape parameter across different conditions. On the other hand, the pattern by which cells respond to a drug treatment, should be monotonic by increasing the drug concentration. For instance, we except to have a decreasing progression rate through G1 phase from control condition to 25 nM, to 100 nM, to 250 nM of lapatinib treatment. To apply this assumption, we forced the scale parameters in both phases to be in a decreasing order across different conditions when all the conditions are being fitted at once. For that, we used linear constrained fitting using "trust-constr" method in scipy.optimize package in Python.

### Synthetic lineage data

We generated synthetic lineage trees with $K$ discrete states and $N$ total number of cells for benchmarking. Lineages were composed of two primary data structures, the state and emissions trees. The state tree was randomly seeded with a root cell determined by the starting probabilities, then expanded by randomly sampling transitions based on the transition probability matrix. After creating the state tree with the desired number of cells, the emission tree is built upon it. Emissions were randomly sampled from the distributions for each cellâs state. Finally, the effects of the emissions were applied to the tree when necessary. If any cells died, their progeny were marked as unobserved by making their emissions NaN values. If applicable, the effects of finite-duration experiments were also applied. Cells existing outside of the experiment duration were marked as unobserved, and those crossing the bounds of an experiment were marked as censored with duration clipped by the experiment.

### Model evaluation

In this part we briefly mention the measures used to quantify the model goodness-of-fit. To find the most likely number of states corresponding to the observations, the Bayesian Information Criterion (BIC) was used [@doi:10.1002/wics.199]. Our model estimates a $k$ element initial probability vector, a $k \times k$ transition matrix, and a $k \times m$ matrix of state-wise parameters where $k$ is the number of states and $m$ is the number of parameters associated with observation distributions. For the phase-specific observation distributions we have a total of 6 parameters including 2 Bernoulli parameters and 2 pairs of shape and scale parameters for Gamma distribution. Since the row-sums for transition and initial probability matrices must be 1, these values are not independent. From distribution analysis of the phase lengths, we realized the shape parameter of the Gamma distribution remains fairly constant over different conditions, while the scale parameter changes. Therefore, the shape parameter was shared between the populations treated with 4 different concentrations of the same compound. Each of these conditions has 2.25 free parameters (1 Bernoulli parameter, 1 scale parameter, and 1/4 shape parameter). The number of free parameters for each state when using phase-specific observations is 4.5. Altogether, the model's degrees of freedom when using phase-specific measurements are $k \times (k - 1) + (k - 1) + k \times 4.5$.
 
The Wasserstein or KantorovichâRubinstein metric is a measure of distance between two distributions. This metric was used to determine the difference between state emissions [@doi:10.1137/1118101]. An analytical solution, the absolute value of the difference in distribution means, was used for the Gamma distribution.

### Model benchmarking

We used emission distributions to represent the phenotypic characteristics of the cells within the lineages. To create our synthetic data we considered two possible options as our set of observations throughout an experiment. In one case, we modeled cell fate and cell lifetime, and in the second, phase-specific fate and duration. In both, we used a Bernoulli distribution for the fate outcomes and a Gamma distribution for time durations. Following is the collection of distribution parameters for the synthetic data.

#### Phase non-specific observations
The parameters are reflective of the cell phenotypes we observed with 5 nM lapatinib treatment. Figures @fig:prop4, @fig:real_5, @fig:performUncenSingle, @fig:performUncenMulti, and @fig:performCenMulti are based on these parameters.

In this table, "Bern p" refers to the Bernoulli parameter, the cell division probability at the end of its lifetime which is equal to 1 - the probability of cell death at the end of its lifetime. "Shape" and "Scale" refer to the Gamma distribution parameters. The cells' lifetime were fitted to Gamma distributions.

| State | Bern p | Shape | Scale |
| :---: |  :---: | :---: | :---: |
|State 1 | 0.99 | 8 | 6 |
| State 2 | 0.75 | 8 | 1 |


#### Phase-specific observations

The data in Figures @fig:censor, @fig:performSyn, @fig:uncenSingle, @fig:uncenMulti, and @fig:cenMulti were created based on the following parameters. These parameters are based on estimations from AU565 cells treated with 5 nM lapatinib.

In this table, "G1 bern" and "G2 bern" are the cell division probabilities at the end of G1 and S/G2 phase, respectively. The "G1 shape" and "G1 scale" are the Gamma distribution parameters of G1 phase lengths. "G2 shape" and "G2 scale" are the Gamma distribution parameters of S/G2 phase lengths.

| State | G1 bern | G2 bern | G1 shape | G1 scale | G2 shape |  G2 scale |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | 
| State 1 | 0.99 | 0.95 | 8 | 7 | 4 | 2 |
|State 2 | 0.95 | 0.9 | 6 | 4 | 3 | 5 |

#### Distant emissions

To create synthetic data with subpopulations of varying dissimilarity (Fig. @fig:wass), we use the phase-specific parameters set except that the values for the G1 phase Gamma shape parameter for state 1 is varied between [4, 12]. This results in an increase in the Wasserstein distance between the two cell states, allowing us to measure state assignment accuracy for different dissimilarity amounts between the two states. Likewise, for Figures @fig:wass1 and @fig:wass2, we simulated the overall cell lifetime duration and varied the Gamma distribution scale parameter from 1 to 8 for state 1.

#### Emissions for BIC figures

Figure @fig:sBIC uses a unique set of parameters for the emissions matrix to simulate varying state numbers in the BIC calculation. 

| State | G1 bern | G2 bern | G1 shape | G1 scale | G2 shape | G2 scale |
:---: | :---: | :---: | :---: | :---: | :---: | :---: | 
| State 1 | 0.99 | 0.9 | 10 | 2 | 10 | 2 |
|State 2 | 0.9 | 0.9 | 20 | 3 | 20 | 3 |
| State 3 | 0.85 | 0.9 | 30 | 4 | 30 | 4 |
| State 4 | 0.8 | 0.9 | 40 | 4 | 40 | 5 |
