## Discussion

In this paper, we introduced a tree-based hidden Markov model that classifies single cells of a heterogeneous population based on solely their over-time phenotypic traits into merely homogeneous subpopulations. Population-level analysis take advantage of only end-point measurements and disregard the heritance of traits across cell generations, miss to identify the importance of cell-cell relations in determining the dynamics of the population. We implemented a modified version of Baum-Welch algorithm for phenotypic observations of tracked single cells in a lineage structure. The tHMM is able to construct and analyze cell lineage trees to properly assign single cells to different states based on virtually any number of phenotypic properties of cell fitness and also, quantify the likelihood of transitioning to a different state using emissions and the transition rate matrix. We benchmarked our model by creating synthetic lineages of cells that mimic the growth and evolution through an experiment. As an application, single cell lineage tracking data of AU565 cancer cells treated with a range of lapatinib and gemcitabine concentrations over 96 hours was inputted to the model. The data included phenotypic observations such as G1 and S/G2 cell cycle phase durations and cell fate at either of these phases. Utilizing the BIC metric, the model predicted 6 and 5 distinct subpopulations for lapatinib and gemcitabine-treated data, respectively, and provided statistical characteristics of each state.  

The significant advancement of tHMM is that it works with virtually any observable and tractable phenotype that can be measured through an experiment. Further, the model was evaluated at an experimentally feasible data size. In our current setting, the observations need to be independent; this way their joint likelihood could be simply calculated as the multiplication of individual likelihoods. The model classified all types of synthetic populations of 2 true states with the accuracy higher than 95% for a minimum of ~100 cells in the population. The model showed relatively high sensitivity to the populations with under-represented subpopulations and proved efficacious with more distinct state features (Figs. @fig:wass1, @fig:wass2). Particularly in comparison to K-means clustering algorithm, the average accuracy of state assignment was higher by 15% (Fig. @fig:wass).

Another advancement in the current work, is the proper handling of the missing information in the form of time censorship both at the beginning (left-truncated) and the end of the experiment (right-censored). For instance, in calculating the Gamma distribution of phase lengths, cells that were living at the beginning of the experiment, or those that outlived the experiment end time, would introduce bias if not properly managed. Specifically, cells with longer lifetimes (i.e. lower growth rate) are more likely to live beyond the tracking period. We separated the censored and fully observed values and handled the censored values using a survival function. Although Bernoulli estimations are centered around their respective true values, they suffer from survivorship bias as well, because cells with higher Bernoulli parameter divide more often and thus have a higher sample size for prediction. This leads to the resistant cell line possessing more accurate Bernoulli estimations relative to the susceptible subpopulation. This challenge is a common complication in such studies and usually is handled in a complicated way or simply disregarded. We showed that ignoring the missing data adversely affected the performance of the model (Fig. @fig:censor c), and that correctly handling it improves the performance (Fig. @fig:censor d).

Naturally, the degree of difference between states that are labeled as "distinct" plays an important role in deciphering which state each cell would belong to. Hence, the model is dependent on some measure of distance between the existing states and may perform poorly when the states are close. The tHMM accurately performs maximum likelihood estimation using cell observations from each lineage in the population. Thus, the improved performance accuracy and decrease in its variance as lineage number increases validates the model architecture. Parameter estimation and initial and transition probability matrix estimations were accurate in almost all cases of synthetic data and the tHMM was able to better distinguish the separate subpopulations as more lineages were added. Furthermore, the model operates equally well whether the population of interest owns a pre-existing phenotypic heterogeneity or the cells acquire diverse phenotypes as a result of drug treatment. The model selection validated by the BIC metric asserted the reliability of tHMM in predicting the most likely number of states within a population (Fig. @fig:sBIC).

As a follow up study, We intend to design assays to experimentally validate the number of states predicted by tHMM, and study the extent and sources of differences between the identified states. The current version of this pipeline is most accurate when populations consist of at least 100 cells. Transitions from therapy-susceptible to therapy-resistant states are well detected by the model, which will prove useful for identifying mutant subtypes in tumors and leading to more optimal therapies for cancer treatment. The tHMM may further be used for drug screening as a single cell, rather than population-based, means of quantifying the potency of novel therapies in eliminating all subpopulations within a tumor. The pipeline will provide researchers and clinicians with an improved classification of heterogeneity among cells, or any other tree-structured data, and provide information about latent changes in cellular identity.
