## Discussion

<!-- Big picture: Importance of this study:
1. Phenotypic intratumoral heterogeneity induces resistance to drug exposure, so we need to account for them in designing anticancer therapy.
2. It is important to take heritability and cell-cell relations into account while studying the evolution and state transitions.
3. Previous studies have investigated identifying phenotypic heterogeneity using models.
4. The tHMM can help with uncovering the underlying heterogeneity using single-cell lineage data using only experimental obervations. -->

Intratumoral heterogeneity in cancer cells enables them to adjust to therapy, and advancement to more malignant stages. Even in the absence of genetic mutations, non-genetic stable variants that are heritable could serve as substrates for natural selection [@doi:10.1038/nrg2556]. For instance, cells with variable growth rates have different susceptibility to estressors such as drug exposure [@doi:10.1016/j.gde.2011.10.001]. Non-genetic phenotypes such as cell cycle durations have been shown to be highly correlated within and across cell generations through lineage analysis [@doi:10.1101/373258].  Therefore, it is vital to identify the sources of non-genetic heterogeneity and provide strategies that include the effect of these variabilities in new therapy regiments. Previous studies have investigated the dynamic of cell state transitions based on the molecular states, differential gene expressions, or cell types but mostly assumed the number and identity of the states are granted [@doi:10.1093/bioinformatics/btp456; @doi:10.1016/j.cell.2011.07.026; @doi:10.1038/s41598-019-46926-x; @doi:10.1016/j.cels.2016.10.015]. Using a state-space model, Nakashima et al., introduced a modified expectation-maximization algorithm to infer cell states from mother-daughter relations and division times [@doi:10.1093/bioinformatics/btaa040], however, they also assumed there are fast- and slow-growing states within the population. Identifying the number of latent states and statistically characterizing such states, while accounting for cell-cell relations has not been the focus of related studies so far. In this paper, we introduced a tree-based hidden Markov model that classifies single cells of a heterogeneous population based on solely their over-time phenotypic traits into merely homogeneous subpopulations. We implemented a modified version of Baum-Welch algorithm for tracked single cells in a lineage structure that could be trained with virtually any number of phenotypic measurements.

<!-- Additional findings and how this fits to existing literature:
1. tHMM shows high sensitivity for under-represented sub-populations.
2. tHMM has proved to be more accurate than K-means clustering which shows the importance of accounting for history of cells and their relations.
3. tHMM properly handles time-censorship using survivoral function of distributions, which is barely the case in the literature.-->

The model was evaluated at an experimentally feasible data size and classified all types of synthetic populations of 2 true states in synthetic data with the accuracy higher than 95% for a minimum of ~100 cells in the population. The tHMM showed relatively high sensitivity to the populations with under-represented subpopulations and proved efficacious with more distinct state features (Figs. @fig:wass1, @fig:wass2). Particularly in comparison to K-means clustering algorithm, the average accuracy of state assignment was higher by 15% (Fig. @fig:wass).Another advancement in the current work, is using suvival functions to properly handle the missing information in the form of time censorship both at the beginning (left-truncated) and the end of the experiment (right-censored) (Fig. @fig:censor).

<!-- Insightful findings from lapatinib treatment fitting, and comparing to some literature about effects of lapatinib on breast cancer cells: -->
As a demonstration, single cell lineage tracking data of AU565 cancer cells treated with a range of lapatinib and gemcitabine concentrations with G1 and S/G2 cell cycle phase durations and cell fate measurements was inputted to the model. Utilizing the BIC metric and the EM algorithm, the model predicted 6 and 5 distinct subpopulations for lapatinib and gemcitabine-treated data, respectively (@fig:expBIC), and provided statistical characteristics of each state (Figs. @fig:emissionsLPT, @fig:emissionsGMC). Lapatinib is known to inhibit the cell proliferation by activating Akt/mTOR pathway, which is a key regulator of G1 phase progression, and decrease the rate of DNA synthesis in AU565 cells [@doi:10.1002/jcb.24611]. Similarly, our analysis in lapatinib-treated population indicated that cells regardless of their states experience prolonged G1 phase, where some states show more susceptibility. Further, those state with higher possibility of cell death, have less cell cycle phase extension (state 3) [refer to our ODE paper maybe?].

In our analysis, we observed that the majority of the predicted states in gemcitabine-treated cells are stable, but also found more disperse effects over the predicted states. Phase arrest or cell death effects in cells treated with gemcitabine appear only when the concentration of gemcitabine reaches 10 nM or higher. Cells in state 5 with a high inward probability, have only 20% chance of survival in S/G2 phase, and most of G1 cell deaths happen in two stable states (state 1 and 3). Gemcitabine induces prolonged DNA damage and is an excellent cadidate for combination therapy [@doi:10.1586/14737140.5.3.429], however, there is limited literature about the effects of gemcitabine specifically on au565 cells or in general, HER2-overexpressing cells.

<!-- Critical analysis of our findings and limitations of the study:
1. Discritizing the state, while in reality they are coninuous variables, is a challenging assumption which may cause inaccuracy to some extent.
2. tHMM cannot perform with high accuracy when the states are too close.
3. In the current setting, the measurements are assumed to be independent. If observations are not independent variables, we should account for that in the likelihood function.
4. The experiment time is limited, and we may not have captured slow-fluctuations. Also, it is hard to collect this type of data for longer times due to experimental limitations.
5. Without further experiments, the molecular interpretations of each state is not clear. -->

In reality, cells live in a continuum of phenotypic and behavioral state [@doi:10.1038/s41591-021-01233-9] and it is more or less arbitrary where to draw the line that discritizes these states. On the other hand, building a model with continuous states has many challenges. That is why we should anticipate errors to some degree in clustering cells with tHMM. Also, the model is dependent on the distance between the existing states and may perform poorly when the states are too close or when cells possessed high variance in parameter estimation (Fig. @fig:wass). Moreover, in our setting, the cell cycle phase durations and fates are assumed to be independent variables. If the measurements are not independent, we need to adjust for that in the likelihood function.

Because our experimental data goes as along as 96 hours it only covers up to 5 or 6 generations of cells. The fact that whether cells after several generations reach a stable equilibrium is not determinable for our dataset. Further, some traits such as resistance may develop over more generations and such slow fluctuations may not be detectable in short-term experiments. On the other hand, data collection for more than 96 hours becomes challenging due to various environmental factors, among which phototoxicity and cell stress [@pmid:27213923]. Of note, the model operates equally well whether the population of interest owns a pre-existing phenotypic heterogeneity (synthetic data figures) or the cells acquire diverse phenotypes as a result of drug treatment (experimental analysis), but it cannot recognize which is the case. The model selection validated by the BIC metric asserted the reliability of tHMM in predicting the most likely number of states within a population (Fig. @fig:sBIC), although without further experimental examinations, the molecular interpretations of said states are not clear.

<!--future directions:
1. Sequencing cells that have been assigned states after fitting and revealing what could be the distinguishing factor for separating those cells assigned to different states.
2. Integerating information about heterogeneity due to mutations to have a comprehensive insight.
3. Based on the findings from sequencing cells, design combination experiments and assess the efficacy.
4. The model is applicable to a wide range of lineage-tree data to unravel the underlying heterogeneity.-->

As a follow up study, We intend to design assays to experimentally validate the number of states predicted by tHMM, and study the extent and sources of differences between the identified states. The tHMM may further be used for drug screening as a single cell, rather than population-based, means of quantifying the potency of novel therapies in eliminating all subpopulations within a tumor. The pipeline will provide researchers and clinicians with an improved classification of heterogeneity among cells, or any other tree-structured data, and provide information about latent changes in cellular identity. This model integrated with information about mutational variations that lead to phenotypic heterogeneity would be extremely useful to design comprehensive therapy regiments in the presence of heterogeneity.
