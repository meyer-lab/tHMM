# Materials and Methods

## Cell Culture Experiments

### Cell Culture Set-up

To model a heterogeneous tumor, we conducted a proof-of-concept experiment by co-culturing cells derived from lung adenocarcinoma: PC-9 and H1299. These cells were obtained from the Meyer Lab at UCLA, where PC-9 cells were already transfected to fluoresce red through a H2B (histone h2b)-mKate2 nuclear localization lentivirus (Sigma-Aldrich, St. Louis, MO) and H1299 green through a H2B-GFP lentivirus (Sigma-Aldrich, St. Louis, MO). Before co-culturing, PC-9 and H1299 cells were grown separately in monolayers in tissue culture-treated well plates, using complete media (Roswell Park Memorial Institute media with L-glutamine (Thermo Fisher Scientific, Canoga Park, CA), supplemented with 5% fetal bovine serum (Corning, Corning, NY) and 1% penicillin/streptomycin (Thermo Fisher Scientific, Canoga Park, CA)). Similar conditions for the well plates and media were used for the co-culture experiment. Cells were passaged every 3 days and thrown out after 9 passages. Co-Culture Set-up and Imaging To co-culture PC-9 and H1299 cells, 200 PC-9 cells/cm2 and 200 H1299 cells/cm2 were taken from their respective well plates and seeded in complete media. Once seeded, cells were treated with 100 nM erlotinib (Selleckchem, Houston, TX), an epidermal growth factor receptor inhibitor which causes significant growth inhibition in PC-9 cells (IC50 = 7 nM) but not in H1299 cells (IC50 > 10 μM).34, 35 Cells were incubated in the Incucyte S3 Live-Cell Analysis System (Incucyte, Ann Arbor, MI) and imaged using phase contrast and fluorescent microscopy. The green channel excitation and emission ranges were 440-480 nm and 504-544 nm, respectively, whereas the red channel excitation and emission ranges were 565-605 nm and 625-705 nm, respectively. The exposure times were 300 ms for the green channel and 400 ms for the red channel. A 20x objective with a numerical aperture of 0.45 was used. Imaging started 24 hours after initial seeding to allow cells to adhere, and images were acquired every 5 minutes for 4 days.

### Cell Tracking and Lineage Generation

To generate lineage trees from the acquired images, a cell image analysis software, ilastik (European Molecular Biology Laboratory, Heidelberg, Germany), was used to track the cells from the time-lapse datasets.36 Before inputting the imagesets into ilastik, Fiji’s ImageJ (NIH) Stackreg plugin was used to correct for in-plane drift.37 Moving to ilastik, pixel classification was used to segment the images, and we employed a tracking with deep learning workflow to training the program on true cell divisions and false detections. This allowed us to construct lineage tracks and link objects between frames. Upon running the pipeline to completion, the output was exported as a comma-separated values (CSV) file containing identification numbers for each cell and corresponding parent cells for each image. Using this CSV file, the parameters of interest, such as cell fate, longevity, and cell type were extracted using the Python programming language.

## Single state model Error in this paragraph?

The first measurement is the cell's fate, encoded as $\phi$ ,where $\phi\in\{0,1\}$, a binary event where $\phi=0$ is the cell dying at the end of its lifetime, and $\phi=1$ is the cell dividing into two daughter cells. The second measurement is the cell's lifetime, encoded as $\tau$, where $\tau\in (0, +\infty)$, a positive real number indicating how long the cell lived in hours. For example, a complete observation could be of the form $\mathbf{x}_{m} = (1, 20)$ where cell $m$ divided into two daughter cells after living for 20 hours. In general, for any observation $\mathbf{x}_{n}$ for cell $n$, we have a tuple indicating the cell fate and the cell lifetime, $\mathbf{x}_{n}=(\phi_{n}, \tau_{n})$. To probabilistically model each observation, the cell fate follows a Bernoulli distribution with Bernoulli rate parameter $p_{B}$ where $p_{B}\in[0,1]$ and $p_{B}$ represents the probability of $\phi=1$, the chance that a cell divides. The cell lifetime follows a right-censored Gompertz distribution with Gompertz rate parameter $c_{G}$ and scale parameter $s_{G}$. The Gompertz distribution models the mortality of cells over time. TODO
 
 ## Multiple state model
 
 Using the parent-daughter links each cell has, we can construct lineage trees which then capture information about the history of cells in the context of their families. Furthermore, for each observation $\mathbf{x}_{n}$ corresponding to cell $n$ in our lineage tree, we introduce a latent or hidden variable $\mathbf{z}_{n}$ which takes one of $K$ discrete values, $\mathbf{z}_{n}\in\{1,2,\ldots,K\}$. Ultimately, our proposed tHMM is comprised of two trees, an observed probabilistic tree and a hidden probabilistic tree. The observed probabilistic tree is defined by the tree set $\mathbf{X}=\left\lbrace\mathbf{x}_{1},\mathbf{x}_{2},\ldots,\mathbf{x}_{N}\right\rbrace$ where $N$ is the number of total cells or observations in our lineage tree. Furthermore, we have a similar construction of the hidden probabilistic tree, defined by the tree set $\mathbf{Z}=\left\lbrace\mathbf{z}_{1},\mathbf{z}_{2},\ldots,\mathbf{z}_{N}\right\rbrace$. The hidden probabilistic tree and the observed probabilistic tree have the same indexing structure. It is important to note that the cell at node $n$ is not necessarily the parent of the cell at node $n+1$ and that the the cell at node $n$ is not necessarily the daughter of the cell at node $n-1$. However, because it is important to denote such relationships not only when describing lineage trees, but also when describing the relevant probability distributions, we introduce $\mathbf{P}(n)$ to denote the cell that is the parent of the cell at node $n$, and $\mathbf{C}(n)$ to denote the set of children of the cell at node $n$. Furthermore, the cell at node $n=1$ or the root node will always be the initial cell in the lineage tree, or the root cell. Cells at the end of the lineage tree, that is to say, cells at the leaves of the tree (nodes with only one edge) will be denoted by the set $\mathbf{L}$. All other cells (cells at nodes that are not leaves) will be denoted by the set $\mathbf{nL}$.
 
To fully describe both trees, we say that a joint distribution ${P}(\mathbf{Z},\mathbf{X})$ follows the tree hidden Markov property if and only if $${{P}(\mathbf{Z},\mathbf{X}) = P}(\mathbf{z}_{1},\mathbf{z}_{2},\ldots,\mathbf{z}_{N},\mathbf{x}_{1},\mathbf{x}_{2},\ldots,\mathbf{x}_{N}) = {P}(\mathbf{z}_{1})\prod_{n=2}^{N}{P}(\mathbf{z}_{n}\mid\mathbf{z}_{\mathbf{P}(n)})\prod_{n=1}^{N}{P}(\mathbf{x}_{n}\mid\mathbf{z}_{n})$$. This factorization of the joint distribution follows from the conditional independence properties of our emissions (i.e. observations) and the Markov tree dependence of the latent variables. These can be easily derived form the Bayesian network diagram in \textbf{Figure 3} which graphically shows the influence of each variable on the other. The similarity to the factorization of hidden Markov chains (HMCs) is also evident, the main difference being that the transition probabilities for tHMMs are ${P}(\mathbf{z}_{n}\mid\mathbf{z}_{\mathbf{P}(n)})$ and the transition probabilities for HMCs are ${P}(\mathbf{z}_{n}\mid\mathbf{z}_{(n-1)})$.

