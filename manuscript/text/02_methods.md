# Materials and Methods

## Cell Culture Experiments

### Cell Culture Set-up

To model a heterogeneous tumor, we conducted a proof-of-concept experiment by co-culturing cells derived from lung adenocarcinoma: PC-9 and H1299. These cells were obtained from the Meyer Lab at UCLA, where PC-9 cells were already transfected to fluoresce red through a H2B (histone h2b)-mKate2 nuclear localization lentivirus (Sigma-Aldrich, St. Louis, MO) and H1299 green through a H2B-GFP lentivirus (Sigma-Aldrich, St. Louis, MO). Before co-culturing, PC-9 and H1299 cells were grown separately in monolayers in tissue culture-treated well plates, using complete media (Roswell Park Memorial Institute media with L-glutamine (Thermo Fisher Scientific, Canoga Park, CA), supplemented with 5% fetal bovine serum (Corning, Corning, NY) and 1% penicillin/streptomycin (Thermo Fisher Scientific, Canoga Park, CA)). Similar conditions for the well plates and media were used for the co-culture experiment. Cells were passaged every 3 days and thrown out after 9 passages. Co-Culture Set-up and Imaging To co-culture PC-9 and H1299 cells, 200 PC-9 cells/cm2 and 200 H1299 cells/cm2 were taken from their respective well plates and seeded in complete media. Once seeded, cells were treated with 100 nM erlotinib (Selleckchem, Houston, TX), an epidermal growth factor receptor inhibitor which causes significant growth inhibition in PC-9 cells (IC50 = 7 nM) but not in H1299 cells (IC50 > 10 μM).34, 35 Cells were incubated in the Incucyte S3 Live-Cell Analysis System (Incucyte, Ann Arbor, MI) and imaged using phase contrast and fluorescent microscopy. The green channel excitation and emission ranges were 440-480 nm and 504-544 nm, respectively, whereas the red channel excitation and emission ranges were 565-605 nm and 625-705 nm, respectively. The exposure times were 300 ms for the green channel and 400 ms for the red channel. A 20x objective with a numerical aperture of 0.45 was used. Imaging started 24 hours after initial seeding to allow cells to adhere, and images were acquired every 5 minutes for 4 days.

### Cell Tracking and Lineage Generation

To generate lineage trees from the acquired images, a cell image analysis software, ilastik (European Molecular Biology Laboratory, Heidelberg, Germany), was used to track the cells from the time-lapse datasets.36 Before inputting the imagesets into ilastik, Fiji’s ImageJ (NIH) Stackreg plugin was used to correct for in-plane drift.37 Moving to ilastik, pixel classification was used to segment the images, and we employed a tracking with deep learning workflow to training the program on true cell divisions and false detections. This allowed us to construct lineage tracks and link objects between frames. Upon running the pipeline to completion, the output was exported as a comma-separated values (CSV) file containing identification numbers for each cell and corresponding parent cells for each image. Using this CSV file, the parameters of interest, such as cell fate, longevity, and cell type were extracted using the Python programming language.

## Single state model

We first build a model of cell growth based on the phenotypic measurement of cells. The first measurement is the cell's fate, encoded as $\phi$ ,where $\phi\in\{0,1\}$, a binary event where $\phi=0$ is the cell dying at the end of its lifetime, and $\phi=1$ is the cell dividing into two daughter cells. The second measurement is the cell's lifetime, encoded as $\tau$, where $\tau\in (0, +\infty)$, a positive real number indicating how long the cell lived in hours. For example, a complete observation could be of the form $\bm{x}_{m} = (1, 20)$ where cell $m$ divided into two daughter cells after living for 20 hours. In general, for any observation $\bm{x}_{n}$ for cell $n$, we have a tuple indicating the cell fate and the cell lifetime, $\bm{x}_{n}=(\phi_{n}, \tau_{n})$. To probabilistically model each observation, the cell fate follows a Bernoulli distribution with Bernoulli rate parameter $p_{B}$ where $p_{B}\in[0,1]$ and $p_{B}$ represents the probability of $\phi=1$, the chance that a cell divides. The cell lifetime follows a right-censored Gompertz distribution with Gompertz rate parameter $c_{G}$ and scale parameter $s_{G}$. The Gompertz distribution models the mortality of cells over time. These underlying parameters also describe the states in the multiple state model discussed later.TODO
 
## Multiple state model

### Model description
 
Using the parent-daughter links each cell has, we can construct lineage trees which then capture information about the history of cells in the context of their families. Furthermore, for each observation $\bm{x}_{n}$ corresponding to cell $n$ in our lineage tree, we introduce a latent or hidden variable $\bm{z}_{n}$ which takes one of $K$ discrete values, $\bm{z}_{n}\in\{1,2,\ldots,K\}$. Ultimately, our proposed tHMM is comprised of two trees, an observed probabilistic tree and a hidden probabilistic tree. The observed probabilistic tree is defined by the set of hierarchal nodes $\bm{X}=\left\lbrace\bm{x}_{1},\bm{x}_{2},\ldots,\bm{x}_{N}\right\rbrace$ where $N$ is the number of total cells or observations in our lineage tree. Furthermore, we have a similar construction of the hidden probabilistic tree, defined by the set of hierarchal nodes $\bm{Z}=\left\lbrace\bm{z}_{1},\bm{z}_{2},\ldots,\bm{z}_{N}\right\rbrace$. The hidden probabilistic tree and the observed probabilistic tree have the same indexing structure. It is important to note that the cell at node $n$ is not necessarily the parent of the cell at node $n+1$ and that the the cell at node $n$ is not necessarily the daughter of the cell at node $n-1$. However, because it is important to denote such relationships not only when describing lineage trees, but also when describing the relevant probability distributions, we introduce $\bm{P}(n)$ to denote the cell that is the parent of the cell at node $n$, and $\bm{C}(n)$ to denote the set of children of the cell at node $n$. Furthermore, the cell at node $n=1$ or the root node will always be the initial cell in the lineage tree, or the root cell. Cells at the end of the lineage tree, that is to say, cells at the leaves of the tree (nodes with only one edge or only one adjacent node) will be denoted by the set $\bm{L}$. All other cells (cells at nodes that are not leaves) will be denoted by the set $\bm{nL}$.
 
To fully describe both trees, we say that a joint distribution ${P}(\bm{Z},\bm{X})$ follows the tree hidden Markov property if and only if $${{P}(\bm{Z},\bm{X}) = P}(\bm{z}_{1},\bm{z}_{2},\ldots,\bm{z}_{N},\bm{x}_{1},\bm{x}_{2},\ldots,\bm{x}_{N}) = {P}(\bm{z}_{1})\prod_{n=2}^{N}{P}(\bm{z}_{n}\mid\bm{z}_{\bm{P}(n)})\prod_{n=1}^{N}{P}(\bm{x}_{n}\mid\bm{z}_{n})$$. This factorization of the joint distribution follows from the conditional independence properties of our emissions (i.e. observations) and the Markov tree dependence of the latent variables. These can be easily derived form the Bayesian network diagram in \textbf{Figure 3} which graphically shows the influence of each variable on the other. The similarity to the factorization of hidden Markov chains (HMCs) is also evident, the main difference being that the transition probabilities for tHMMs are ${P}(\bm{z}_{n}\mid\bm{z}_{\bm{P}(n)})$ and the transition probabilities for HMCs are ${P}(\bm{z}_{n}\mid\bm{z}_{(n-1)})$.

### Parameters

Each factor in the tree hidden Markov property in represents a key parameter in the tHMM. Fully describing it with known values specifies the entire model. The following parameters are similar to those used in describing HMCs.

We first introduce the hyperparameter $K$ which is the number of possible discrete hidden states the hidden variables can take. This is the only parameter the user is required to input as all the other parameters depend on the value of $K$. Ultimately, each state $k\in\{1,2,\ldots,K\}$ uniquely describes the distributions (Bernoulli and Gompertz distributions) via the respective parameters ($p_{B}^{(k)}$, $c_{G}^{(k)}$, and $s_{G}^{(k)}$) governing the respective observations or emissions (cell fate $\phi$ and cell lifetime $\tau$) for a group of cells. By ascribing a group of cells in the lineage tree a particular state $k\in\{1,2,\ldots,K\}$, we can identify subpopulations of interest based on the ascribed states of other groups of cells. For example, if the root cell was found to be of state $1$, that is to say, $\bm{z}_{1}=1$, but all cells at the leaves further down in the lineage were found to be of state $2$, then it is reasonable to assume that sometime in the lineage, a transition between states $1$ and $2$ occurred. One can then further interrogate and ascribe meaning to each of the states. That is, if state $1$ described a Bernoulli distribution with Bernoulli rate parameter $p_{B}^{(1)}=0.5$ but state $2$ described a Bernoulli distribution with Bernoulli rate parameter $p_{B}^{(2)}=0.9$, then state $2$ can be identified as cells that are resilient or highly proliferative compared to cells of state $1$. The meaning ascribed to each state is furnished by the user upon interrogation of the distributions that each state uniquely describes. Sometimes the number of states $K$ can be arbitrarily chosen; for example, if the number of states selected equals the number of cells totally observed, that is, $K=N$, then each cell will be ascribed its own unique state and the goal of using our model to identify heterogeneity is trivialized. To prevent an arbitrary selection of $K$, the Akaike information criterion (AIC) is used for model selection and can inform the user of what value of $K$ is best.
    
Once the number of discrete states $K$ is chosen, the three other parameters describing tree hidden Markov property can be built. The first parameter is a vector of initial hidden state priors or an initial probability distribution over the set of states. This describes the probability $P(\bm{z}_{1})$, or more explicitly, $P(\bm{z}_{1}=k)$ for some state $k\in\{1,2,\ldots,K\}$, which is then encoded as $\pi_{k}$. That is to say, $\pi_{k}$ is the probability that the hidden root node is of state $k$ for $k\in\{1,2,\ldots,K\}$. Note that for some states $j\in\{1,2,\ldots,K\}$, $\pi_{j}=0$, implying that they cannot be initial states. This is stored as a $K$-dimensional vector $\bm{\pi}$ where the $j$-th entry is $\pi_{j}=P(\bm{z}_{1}=j)$ for $j\in\{1,2,\ldots,K\}$.
    
The second parameter is a matrix of state transition probabilities stored as a square $K\times K$ matrix $\bm{T}$. Each element of the matrix $T_{jk}$ represents the probability of going to state $k$ (column-element) from state $j$ (row-element). More explicitly, $T_{jk} = {P}(\bm{z}_{n}=k\mid\bm{z}_{\bm{P}(n)}=j)$ for some states $j,k \in \{1,2,\ldots,K\}$. Note that the diagonal of $\bm{T}$ consists of entries of the form $T_{kk}$, the probability of the child state inheriting same state as the parent cell.
    
The third parameter is $K$-long dictionary of parameters for the distributions each state uniquely describes. We call this dictionary $\bm{E}=\{E_{1},E_{2},\ldots,E_{K}\}$ where for some $k\in\{1,2,\ldots,K\}$, the parameters describing the distributions of state $k$ are stored as $E_{k}=\{p_{B}^{(k)},c_{G}^{(k)},s_{G}^{(k)}\}$. This parameter describes the final remaining factor in the tree hidden Markov property, the emission likelihoods ${P}(\bm{x}_{n}\mid\bm{z}_{n})$. More explicitly, for some state $k\in\{1,2,\ldots,K\}$ and for some observation $(\phi_{n}, \tau_{n})$, we are trying to describe the probability ${P}(\bm{x}_{n}=(\phi_{n}, \tau_{n})\mid\bm{z}_{n}=k)$. Here we assume the observations are conditionally independent given then respective state variable or we assume a Naive Bayes condition on the emissions (each feature or observation $\phi_{n},\tau_{n}$ is conditionally independent of the other given the category or state $k$):
    
